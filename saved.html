<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8" />
  <title>Saved Workouts â€“ GymRoll</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <a href="index.html" class="saved-link">ğŸ  Home</a>
  
  <h1>ğŸ“‹ Saved Workouts</h1>
  
  <div id="controls" style="max-width: 800px; margin: 20px auto; padding: 0 20px;">
    <input type="text" id="searchInput" placeholder="Search workouts..." style="width: 100%; padding: 12px; background: var(--gray); color: var(--text); border: 2px solid var(--accent); border-radius: 8px; font-size: 1rem; box-sizing: border-box; margin-bottom: 15px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <span id="workoutCount" style="color: #aaa;"></span>
      <button id="clearAllBtn" class="clear-all-btn" style="padding: 8px 16px; background: #ff4444; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Clear All</button>
    </div>
  </div>
  
  <div id="savedWorkoutsList"></div>
  
  <script>
    // Check if localStorage is available
    function isLocalStorageAvailable() {
      try {
        const test = '__localStorage_test__';
        localStorage.setItem(test, test);
        localStorage.removeItem(test);
        return true;
      } catch (e) {
        return false;
      }
    }
    
    // Get saved workouts with error handling
    function getSavedWorkouts() {
      if (!isLocalStorageAvailable()) return [];
      try {
        return JSON.parse(localStorage.getItem('gymroll_saved_workouts') || '[]');
      } catch (e) {
        console.error('Error reading saved workouts:', e);
        return [];
      }
    }
    
    // Sanitize HTML
    function sanitizeHTML(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }
    
    let allWorkouts = [];
    let filteredWorkouts = [];
    
    // Load saved workouts
    function loadSavedWorkouts(searchTerm = '') {
      allWorkouts = getSavedWorkouts();
      
      // Filter by search term
      if (searchTerm.trim()) {
        const term = searchTerm.toLowerCase();
        filteredWorkouts = allWorkouts.filter(workout => 
          workout.name.toLowerCase().includes(term) ||
          workout.settings.muscle.toLowerCase().includes(term) ||
          workout.settings.intensity.toLowerCase().includes(term) ||
          workout.exercises.some(ex => ex.title.toLowerCase().includes(term))
        );
      } else {
        filteredWorkouts = [...allWorkouts];
      }
      
      // Sort by date (newest first)
      filteredWorkouts.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      const container = document.getElementById('savedWorkoutsList');
      const countEl = document.getElementById('workoutCount');
      
      countEl.textContent = `${filteredWorkouts.length} workout${filteredWorkouts.length !== 1 ? 's' : ''} saved`;
      
      if (filteredWorkouts.length === 0) {
        container.innerHTML = '<p style="color: #aaa; margin-top: 40px;">' + 
          (searchTerm ? 'No workouts match your search.' : 'No saved workouts yet. Generate a workout and save it to see it here!') + 
          '</p>';
        return;
      }
      
      container.innerHTML = filteredWorkouts.map(workout => {
        const date = new Date(workout.date).toLocaleDateString('en-US', { 
          year: 'numeric', 
          month: 'short', 
          day: 'numeric' 
        });
        const exercisesHtml = workout.exercises.map(ex => {
          const mats = ex.materials ? `, requires materials: ${sanitizeHTML(ex.materials)}` : '';
          return `<div style="margin-bottom:12px"><strong>${sanitizeHTML(ex.title)}</strong> <span style="color:#999;font-size:0.9rem">(${sanitizeHTML(ex.intensity)} Intensity${mats})</span></div>`;
        }).join('');
        
        return `
          <div class="saved-workout-card" data-workout-id="${workout.id}">
            <div class="workout-header">
              <h2>${sanitizeHTML(workout.name)}</h2>
              <button class="delete-btn" data-delete-id="${workout.id}" title="Delete workout">ğŸ—‘ï¸</button>
            </div>
            <div class="workout-meta">
              <span>${sanitizeHTML(workout.settings.length)} â€¢ ${sanitizeHTML(workout.settings.intensity)} â€¢ ${sanitizeHTML(workout.settings.muscle)} â€¢ Materials: ${sanitizeHTML(workout.settings.materials)}</span>
              <span style="color: #666; font-size: 0.9rem;">Saved on ${date}</span>
            </div>
            <div class="workout-exercises">
              ${exercisesHtml}
            </div>
          </div>
        `;
      }).join('');
    }
    
    function deleteWorkout(id) {
      if (!confirm('Are you sure you want to delete this workout?')) return;
      
      if (!isLocalStorageAvailable()) {
        alert('Local storage is not available.');
        return;
      }
      
      try {
        const savedWorkouts = getSavedWorkouts();
        const filtered = savedWorkouts.filter(w => w.id !== id);
        localStorage.setItem('gymroll_saved_workouts', JSON.stringify(filtered));
        loadSavedWorkouts(document.getElementById('searchInput').value);
      } catch (e) {
        alert('Failed to delete workout: ' + e.message);
      }
    }
    
    function clearAllWorkouts() {
      if (!confirm('Are you sure you want to delete ALL saved workouts? This cannot be undone.')) return;
      
      if (!isLocalStorageAvailable()) {
        alert('Local storage is not available.');
        return;
      }
      
      try {
        localStorage.removeItem('gymroll_saved_workouts');
        loadSavedWorkouts();
      } catch (e) {
        alert('Failed to clear workouts: ' + e.message);
      }
    }
    
    // Event delegation for delete buttons (set up once)
    const container = document.getElementById('savedWorkoutsList');
    if (container) {
      container.addEventListener('click', (e) => {
        const deleteBtn = e.target.closest('.delete-btn');
        if (deleteBtn) {
          const workoutId = deleteBtn.getAttribute('data-delete-id');
          if (workoutId) {
            deleteWorkout(workoutId);
          }
        }
      });
    }
    
    // Search functionality
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
      searchInput.addEventListener('input', (e) => {
        loadSavedWorkouts(e.target.value);
      });
    }
    
    // Clear all button
    const clearAllBtn = document.getElementById('clearAllBtn');
    if (clearAllBtn) {
      clearAllBtn.addEventListener('click', (e) => {
        e.preventDefault();
        clearAllWorkouts();
      });
    }
    
    // Load on page load
    loadSavedWorkouts();
  </script>
</body>
</html>

